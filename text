import requests

API_URL = "https://your-service-name.onrender.com/get-credentials"
API_TOKEN = "a2htZW5odWFrdXltYWV5ZWQ="

def download_credentials():
    headers = {"X-API-Token": API_TOKEN}
    response = requests.get(API_URL, headers=headers)
    if response.status_code == 200:
        with open("credentials.json", "wb") as f:
            f.write(response.content)
        print("Downloaded credentials.json from API")
    else:
        raise Exception(f"Failed to download credentials: {response.status_code} {response.text}")

def connect_gsheet():
    # ก่อนใช้ Google API ต้องดาวน์โหลดไฟล์ก่อน
    download_credentials()

    import gspread
    from google.oauth2.service_account import Credentials

    SHEET_NAME = "Users"
    SPREADSHEET_ID = "1rQnV_-30tmb8oYj7g9q6-YdyuWZZ2c8sZ2xH7pqszVk"

    scope = ["https://spreadsheets.google.com/feeds",
             "https://www.googleapis.com/auth/drive"]
    creds = Credentials.from_service_account_file("credentials.json", scopes=scope)
    client = gspread.authorize(creds)
    sheet = client.open_by_key(SPREADSHEET_ID)
    return sheet

def load_users():
    sheet = connect_gsheet()
    user_sheet = sheet.worksheet(SHEET_NAME)
    users = user_sheet.col_values(1)[1:]  # ข้าม header
    return users
