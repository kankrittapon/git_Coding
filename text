import json
import sys
import os
from pathlib import Path

from live_mode import run_live_mode_for_user
from trial_mode import start_trial_mode as run_trial_mode
from utils import connect_gsheet

# ==== à¸£à¸­à¸‡à¸£à¸±à¸š path à¸ªà¸³à¸«à¸£à¸±à¸š PyInstaller onefile ====
def resource_path(relative_path):
    try:
        base_path = sys._MEIPASS  # PyInstaller runtime
    except Exception:
        base_path = Path(__file__).resolve().parent
    return Path(base_path) / relative_path

# ==== à¸žà¸²à¸˜ config ====
USER_CONFIG_PATH = Path(__file__).resolve().parent / "user_config.json"  # à¹ƒà¸«à¹‰à¹à¸à¹‰à¹„à¸”à¹‰
LINE_USER_CONFIG_PATH = Path(__file__).resolve().parent / "booking_elements/config_line_user.json"  # à¹ƒà¸«à¹‰à¹à¸à¹‰à¹„à¸”à¹‰
BRANCH_CONFIG_PATH = resource_path("branch/config.json")  # à¸«à¹‰à¸²à¸¡à¹à¸à¹‰
TIME_CONFIG_PATH = resource_path("branch/time.json")      # à¸«à¹‰à¸²à¸¡à¹à¸à¹‰

DEFAULT_USER_ROLES = {
    "admin": {"max_profiles": 999, "can_use_scheduler": True},
    "vip2": {"max_profiles": 5, "can_use_scheduler": True},
    "vip1": {"max_profiles": 3, "can_use_scheduler": True},
    "normal": {"max_profiles": 1, "can_use_scheduler": False},
}

def load_user_credentials_from_gsheet():
    try:
        print("à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹à¸¥à¸°à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸ˆà¸²à¸ Google Sheet...")
        sheet = connect_gsheet()
        user_sheet = sheet.worksheet("Users")
        all_records = user_sheet.get_all_records()

        user_credentials = []
        for record in all_records:
            username = record.get("Username")
            password = record.get("Password")
            role = record.get("Role")

            if username and password and role:
                max_profiles_from_sheet = record.get("Max Profiles")
                can_use_scheduler_from_sheet = record.get("Can Use Scheduler")

                effective_max_profiles = DEFAULT_USER_ROLES.get(role, {}).get("max_profiles", 1)
                if max_profiles_from_sheet is not None:
                    try:
                        effective_max_profiles = int(max_profiles_from_sheet)
                    except ValueError:
                        print(f"âš ï¸ Warning: Max Profiles invalid for {username}, fallback used.")

                effective_can_use_scheduler = DEFAULT_USER_ROLES.get(role, {}).get("can_use_scheduler", False)
                if can_use_scheduler_from_sheet is not None:
                    effective_can_use_scheduler = str(can_use_scheduler_from_sheet).strip().upper() == "TRUE"

                user_credentials.append({
                    "username": username,
                    "password": password,
                    "role": role,
                    "max_profiles": effective_max_profiles,
                    "can_use_scheduler": effective_can_use_scheduler
                })
            else:
                print(f"âš ï¸ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹„à¸¡à¹ˆà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ: {record}")

        print(f"âœ… à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ {len(user_credentials)} à¸£à¸²à¸¢à¸à¸²à¸£à¸ˆà¸²à¸ Google Sheet à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§.")
        return user_credentials
    except Exception as e:
        print(f"âŒ à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Google Sheet à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: {e}")
        return []

def authenticate_user(username, password, gsheet_users_data):
    for user_cred in gsheet_users_data:
        if user_cred.get("username") == username and user_cred.get("password") == password:
            return user_cred
    return None

def load_json_config(path):
    try:
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    except Exception as e:
        print(f"âŒ à¹‚à¸«à¸¥à¸” config à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ ({path}): {e}")
        return {}

def get_available_profiles(username, user_config):
    return [u for u in user_config.get("users", []) if u["username"] == username]

def load_line_credentials(username, profile_name, line_accounts):
    for account in line_accounts:
        if account["username"] == username and account["profile_name"] == profile_name:
            print(f"âœ… à¹‚à¸«à¸¥à¸” LINE login à¸ªà¸³à¸«à¸£à¸±à¸š '{username}' ({profile_name}) à¹à¸¥à¹‰à¸§.")
            return account.get("line_email"), account.get("line_password")
    print(f"âš ï¸ à¹„à¸¡à¹ˆà¸žà¸š LINE login à¸ªà¸³à¸«à¸£à¸±à¸š '{username}' ({profile_name}).")
    return None, None

def run_cli_mode(all_configs, gsheet_users_data):
    print("\n--- à¹‚à¸«à¸¡à¸” CLI ---")
    username = input("Username: ").strip()
    password = input("Password: ").strip()

    user = authenticate_user(username, password, gsheet_users_data)
    if not user:
        print("âŒ Username à¸«à¸£à¸·à¸­ Password à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡.")
        return

    print(f"âœ… à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸¸à¸“ {username} (Role: {user['role']})")

    profiles = get_available_profiles(username, all_configs['user_profiles'])
    if user['role'] != 'admin':
        profiles = profiles[:user['max_profiles']]

    if not profiles:
        print("âŒ à¹„à¸¡à¹ˆà¸žà¸šà¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¸‚à¸­à¸‡à¸„à¸¸à¸“à¹ƒà¸™ user_config.json")
        return

    print("\nðŸ“‹ à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¸—à¸µà¹ˆà¸„à¸¸à¸“à¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸¥à¸·à¸­à¸:")
    for i, p in enumerate(profiles, 1):
        print(f"{i}. {p['browser']} - {p['profile_name']}")

    try:
        choice = int(input("à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ: "))
        selected = profiles[choice - 1]
        browser = selected['browser']
        profile_name = selected['profile_name']

        line_email, line_password = load_line_credentials(username, profile_name, all_configs['line_accounts'])

        branches = all_configs['branches']
        if not branches:
            print("âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸£à¸²à¸¢à¸Šà¸·à¹ˆà¸­à¸ªà¸²à¸‚à¸²à¹„à¸”à¹‰")
            return
        print("\nðŸ¢ à¹€à¸¥à¸·à¸­à¸à¸ªà¸²à¸‚à¸²:")
        for i, b in enumerate(branches, 1):
            print(f"{i}. {b}")
        branch = branches[int(input("à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¸ªà¸²à¸‚à¸²: ")) - 1]

        day = int(input("à¹€à¸¥à¸·à¸­à¸à¸§à¸±à¸™ (1-31): "))

        times = all_configs['times']
        for i, t in enumerate(times, 1):
            print(f"{i}. {t}")
        time_index = int(input("à¹€à¸¥à¸·à¸­à¸à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¹€à¸§à¸¥à¸²: ")) - 1

        run_live_mode_for_user(username, browser, profile_name, branch, day, time_index, line_email, line_password)

    except Exception as e:
        print(f"âŒ à¸¡à¸µà¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”: {e}")

def start():
    all_configs = {
        'user_profiles': load_json_config(USER_CONFIG_PATH),
        'line_accounts': load_json_config(LINE_USER_CONFIG_PATH).get("line_accounts", []),
        'branches': load_json_config(BRANCH_CONFIG_PATH),
        'times': load_json_config(TIME_CONFIG_PATH),
    }

    gsheet_users_data = load_user_credentials_from_gsheet()
    if not gsheet_users_data:
        print("âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹‚à¸«à¸¥à¸”à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¸ˆà¸²à¸ Google Sheet à¹„à¸”à¹‰.")
        return

    mode_arg = sys.argv[1] if len(sys.argv) > 1 else ""

    if mode_arg == "--gui":
        print("ðŸ”· à¹€à¸£à¸´à¹ˆà¸¡à¹‚à¸«à¸¡à¸” GUI...")
        from gui_app import run_gui_app
        run_gui_app(all_configs, gsheet_users_data)
    else:
        run_cli_mode(all_configs, gsheet_users_data)

if __name__ == "__main__":
    start()
